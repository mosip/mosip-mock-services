# Mock ABIS

## üìå Overview
The `mock-abis` module is a mock implementation of the Automated Biometric Identification System (ABIS). It is designed to facilitate the testing of non-production MOSIP deployments by simulating ABIS functionality. This module supports testing `INSERT` and `IDENTIFY` operations via a Swagger API and integrates with ActiveMQ to process biometric data like a real ABIS would.

## ‚ú® Features
-   **ABIS Simulation**: Simulates core ABIS operations including Insert and Identify.
-   **Configurable Expectations**: Allows setting up specific responses (Success/Error), error codes, and delays to test various scenarios.
-   **Partner Encryption Support**: Supports partner-based encryption using certificates.
-   **ActiveMQ Integration**: Consumes and produces messages to/from ActiveMQ queues for asynchronous processing.
-   **Swagger Interface**: Provides a user-friendly interface to interact with the mock service and configure expectations.
-   **Local Development Friendly**: Supports in-memory H2 database for easy local setup.

## üõ†Ô∏è Services
-   **mock-abis-service**: The core service that handles API requests, processes queue messages, manages mock logic, and stores biometric data in memory.

## ‚öôÔ∏è Local Setup
There are two primary ways to deploy the `mock-abis` module locally:
1.  **[Local Setup using Docker Image](#local-setup-using-docker-image)**: Recommended for consistent environment setup.
2.  **[Local Setup by Building Docker Image](#local-setup-by-building-docker-image)**: If you need to build from source.
3.  **[Local Setup (JAR)](#local-setup-using-jar)**: Useful for development and debugging.

## üìã Pre requisites
Before setting up the project, ensure you have the following prerequisites:
-   **Java 21**: The project requires Java 21.
-   **Maven**: For building the project.
-   **Docker & Docker Compose**: For Docker-based setup.
-   **ActiveMQ**: A local or remote ActiveMQ instance.
    -   **Local Run**: Navigate to the `activemq` directory and run `docker-compose up`.
    -   **Access**: `http://localhost:8161/`
-   **Dependencies**:
    -   `kernel-auth-adapter.jar`: Required in the `lib` folder for JAR execution.

## üóÑÔ∏è Database Setup
For local development, `mock-abis` uses an **H2 in-memory database**.
-   **Steps**: No manual SQL execution is required. The schema is auto-generated by Hibernate at startup.
-   **Configuration**:
    ```properties
    javax.persistence.jdbc.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1
    javax.persistence.jdbc.driver=org.h2.Driver
    javax.persistence.jdbc.user=sa
    javax.persistence.jdbc.password=sa
    hibernate.ddl-auto=update
    hibernate.temp.use_jdbc_metadata_defaults=false
    hibernate.dialect=org.hibernate.dialect.H2Dialect
    ```

## üìù Configurations
The service connects to ActiveMQ and other internal components.
-   **Queue Configuration**:
    Create `src/main/resources/registration-processor-abis.json` using `registration-processor-abis-sample.json` as a template. Update the `brokerUrl` and queue names as needed.
    ```json
    {
      "abis": [
        {
          "name": "ABIS",
          "host": "",
          "port": "",
          "brokerUrl": "tcp://{env}.mosip.net:{port}",
          "inboundQueueName": "ctk-to-abis",
          "outboundQueueName": "abis-to-ctk",
          "pingInboundQueueName": "ctk-to-abis",
          "pingOutboundQueueName": "abis-to-ctk",
          "userName": "artemis",
          "password": "{password}",
          "typeOfQueue": "ACTIVEMQ",
          "inboundMessageTTL": 2700
        }
      ]
    }
    ```
-   **Partner Certificate**:
    Place `cbeff.p12` in the `resource` folder (or `src/main/resources`) if encryption is enabled. Upload the certificate using the Swagger upload certificate request if needed.

## üê≥ Local Setup using docker image
To run using an existing Docker image:
1.  Ensure you have `sample-docker-compose.yml` or create a `docker-compose.yml`.
2.  Run the following command:
    ```bash
    docker-compose -f sample-docker-compose.yml up
    ```
    *(Note: Ensure ActiveMQ is running and reachable).*

## üê≥ Docker based Server deployment (Sandbox)
To build the image and deploy (or push for sandbox):

1.  **Build the Code**:
    ```bash
    mvn clean install -Dgpg.skip=true
    ```
2.  **Create Docker Image**:
    ```bash
    docker build --file Dockerfile --tag mock-abis .
    ```
3.  **Push Image (Optional)**:
    Push the docker image to your docker registry if deploying to a remote sandbox.
    ```bash
    docker push <your-registry>/mock-abis:latest
    ```
4.  **Run Container Locally (Optional)**:
    You can also directly use these images for running mock ABIS locally.
    ```bash
    docker run -p 8081:8081 mock-abis
    ```
    *Note: Check `Dockerfile` for passing env properties.*

## ‚òï Local Development (JAR)
This section is for developers to run `mock-abis` locally. You can run it against a remote MOSIP server's queue or fully locally with a local ActiveMQ.

### 1. Requirements
*   **ActiveMQ**:
    *   **Fully Local**: Run local ActiveMQ.
        ```bash
        cd activemq
        docker-compose up
        ```
        Open: `http://localhost:8161/`
    *   **Against Server**: Ensure you have credentials and connectivity to the Server's ActiveMQ.
*   **Database**: Uses H2 in-memory DB (already configured).

### 2. Steps
1.  **Setting ABIS Queue Conf**:
    -   Create `registration-processor-abis.json` in `src/main/resources`.
    -   Copy the contents of `registration-processor-abis-sample.json`.
    -   Update with correct queue details (refer to [Configurations](#-configurations)).
2.  **Prepare Libs**:
    -   Download the latest `kernel-auth-adapter` from Maven Repository and save it into a `lib` folder.
3.  **Build the Code**:
    ```bash
    mvn clean install -Dgpg.skip=true
    ```
4.  **Run the JAR**:
    ```bash
    java -Dloader.path=lib/kernel-auth-adapter-1.3.0-SNAPSHOT.jar \
    -Dlocal.development=true -Dabis.bio.encryption=true \
    -Dspring.profiles.active=local -Dmosip_host=https://<server hostname> \
    --add-opens java.xml/jdk.xml.internal=ALL-UNNAMED \
    --add-opens java.base/java.lang.reflect=ALL-UNNAMED \
    --add-opens java.base/java.lang.stream=ALL-UNNAMED \
    --add-opens java.base/java.time=ALL-UNNAMED \
    --add-opens java.base/java.time.LocalDate=ALL-UNNAMED \
    --add-opens java.base/java.time.LocalDateTime=ALL-UNNAMED \
    --add-opens java.base/java.io.Reader=ALL-UNNAMED \
    --add-opens java.base/java.util.Optional=ALL-UNNAMED \
    --add-opens java.base/java.time.LocalDateTime.date=ALL-UNNAMED \
    -jar target/mock-abis-1.3.0-SNAPSHOT.jar
    ```

### 3. Flags
| Flag | Description |
| :--- | :--- |
| `local.development` | `true`: Uses `registration-processor-abis.json` from resources. |
| `abis.bio.encryption` | `true`: Enables partner based encryption (requires `cbeff.p12`). |
| `mosip_host` | Hostname of the MOSIP server. |

## üöÄ Deployment
For deploying in a Kubernetes environment (like Sandbox), the service is deployed as a Docker container. Refer to the specific MOSIP deployment scripts and Helm charts for environmental configuration.

## ‚¨ÜÔ∏è Upgrade
To upgrade:
1.  Git pull latest changes.
2.  Update dependencies in `pom.xml`.
3.  Rebuild: `mvn clean install`.
4.  Rebuild Docker image.

## üìö Documentation
-   **Expectations Guide**: [Sample Expectations](./docs/sampleExpectations.md)

### APIs for configuration and expectation setting

#### Update configuration
**URL**: `http://{host}/v1/mock-abis-service/config/configure`  
**Method**: `POST`  
**Request**:
```json
{
  "findDuplicate": "false"
}
```
**Response**:
```text
Successfully updated the configuration
```

#### Get configuration
**URL**: `http://{host}/v1/mock-abis-service/config/configure`  
**Method**: `GET`  
**Response**:
```json
{
  "findDuplicate": false
}
```

#### Set Expectation
**URL**: `http://{host}/v1/mock-abis-service/config/expectation`  
**Method**: `POST`  
**Request**:
```json
{
  "id": "<Hash of the biometric>",
  "version": "[xxxxx]",
  "requesttime": "2021-05-05T05:44:58.525Z",
  "actionToInterfere": "Identify/Insert",
  "forcedResponse": "Error",
  "errorCode": "",
  "delayInExecution": "",
  "gallery": {
    "referenceIds": [
      {
        "referenceId": "<Hash of the duplicate biometric>"
      }
    ]
  }
}
```
**Response**:
```text
Successfully inserted expectation $expectation_id
```

#### Get Expectations
**URL**: `http://{host}/v1/mock-abis-service/config/expectation`  
**Method**: `GET`  
**Response**:
```json
{
  "abshd": {
    "id": "abshd",
    "version": "xxxxx",
    "requesttime": "2021-05-05T05:44:58.525Z",
    "actionToInterfere": "Identify/Insert",
    "forcedResponse": "Error/Success",
    "errorCode": "",
    "delayInExecution": "",
    "gallery": {
      "referenceIds": [
        {
          "referenceId": "xxxxxx"
        },
        {
          "referenceId": "xxxxxx"
        }
      ]
    }
  },
  "dffefe": {
    "id": "dffefe",
    "version": "xxxxx",
    "requesttime": "2021-05-05T05:44:58.525Z",
    "actionToInterfere": "Identify/Insert",
    "forcedResponse": "Error/Success",
    "errorCode": "",
    "delayInExecution": "",
    "gallery": {
      "referenceIds": [
        {
          "referenceId": "xxxx"
        },
        {
          "referenceId": "xxxxxx"
        }
      ]
    }
  }
}
```

#### Delete Expectation
**URL**: `http://{host}/v1/mock-abis-service/config/expectation/{id}`  
**Method**: `DELETE`  
**Response**:
```text
Successfully deleted expectation $expectation_id
```

## üí° Tips & tricks
1.  While setting the expectation the hash of iso image should be taken, directly taking bdb hash will not work.
    ```text
    formula for hash: SHA256_hash(base64_decode(bdb))
    ```
2.  Use get cached biometrics to check whether the hashes are proper.

### Developer Tips
This section is for developers to develop this module fast & efficiently:
1.  Use local profile: `-Dspring.profiles.active=local`. Pass this as VM options.
2.  Pass: `mosip_host=https://<mosip host>` as env variable.
3.  Setting ABIS queue conf:
    -   Create `registration-processor-abis.json` in resources.
    -   Copy the contents of `registration-processor-abis-sample.json` to `registration-processor-abis.json`.
    -   Update `registration-processor-abis.json` with the correct queue details.
    
    By performing the above steps, you are ready to run mock-ABIS in local machine.

### API Documentation
API documentation is available [here](https://mosip.github.io/documentation/) and via Swagger:
[Swagger UI Local](http://localhost:8081/v1/mock-abis-service/swagger-ui/index.html#/)

### Product Documentation
To know more about Mock ABIS in the perspective of functional and use cases you can refer to our main document:
[MOSIP Documentation](https://docs.mosip.io)

## ü§ù Contribution & Community
We welcome contributions from everyone!

[Check here](https://docs.mosip.io/1.2.0/community/code-contributions) to learn how you can contribute code to this application.

If you have any questions or run into issues while trying out the application, feel free to post them in the [MOSIP Community](https://community.mosip.io/) ‚Äî we‚Äôll be happy to help you out.

[![GitHub Issues](https://img.shields.io/badge/GitHub-Issues-181717?style=flat&logo=github&logoColor=white)](https://github.com/mosip/mosip-mock-services/issues)

## üìù License
![License: MPL 2.0](https://img.shields.io/badge/License-MPL_2.0-brightgreen.svg)

This project is licensed under the terms of [Mozilla Public License 2.0](LICENSE).
See the [LICENSE](LICENSE) file for full license details.