# Mock ABIS

## üìå Overview
The `mock-abis` module is a mock implementation of the Automated Biometric Identification System (ABIS). It is designed to facilitate the testing of non-production MOSIP deployments by simulating ABIS functionality. This module supports testing `INSERT` and `IDENTIFY` operations via a Swagger API and integrates with ActiveMQ to process biometric data like a real ABIS would.

## ‚ú® Features
-   **ABIS Simulation**: Simulates core ABIS operations including Insert and Identify.
-   **Configurable Expectations**: Allows setting up specific responses (Success/Error), error codes, and delays to test various scenarios.
-   **Partner Encryption Support**: Supports partner-based encryption using certificates.
-   **ActiveMQ Integration**: Consumes and produces messages to/from ActiveMQ queues for asynchronous processing.
-   **Swagger Interface**: Provides a user-friendly interface to interact with the mock service and configure expectations.
-   **Local Development Friendly**: Supports in-memory H2 database for easy local setup.

## üõ†Ô∏è Services
-   **mock-abis-service**: The core service that handles API requests, processes queue messages, manages mock logic, and stores biometric data in memory.

## ‚öôÔ∏è Local Setup
There are two primary ways to deploy the `mock-abis` module locally:
1.  **[Local Setup using Docker Image](#local-setup-using-docker-image)**: Recommended for consistent environment setup.
2.  **[Local Setup by Building Docker Image](#local-setup-by-building-docker-image)**: If you need to build from source.
3.  **[Local Setup (JAR)](#local-setup-using-jar)**: Useful for development and debugging.

## üìã Pre requisites
Before setting up the project, ensure you have the following prerequisites:
-   **Java 21**: The project requires Java 21.
-   **Maven**: For building the project.
-   **Docker & Docker Compose**: For Docker-based setup.
-   **ActiveMQ**: A local or remote ActiveMQ instance.
-   **Dependencies**:
    -   `kernel-auth-adapter.jar`: Required in the `lib` folder for JAR execution.

## üóÑÔ∏è Database Setup
For local development, `mock-abis` uses an **H2 in-memory database**.
-   **Steps**: No manual SQL execution is required. The schema is auto-generated by Hibernate at startup.
-   **Configuration**:
    ```properties
    javax.persistence.jdbc.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1
    javax.persistence.jdbc.driver=org.h2.Driver
    javax.persistence.jdbc.user=sa
    javax.persistence.jdbc.password=sa
    hibernate.ddl-auto=update
    hibernate.temp.use_jdbc_metadata_defaults=false
    hibernate.dialect=org.hibernate.dialect.H2Dialect
    ```

## üìù Configurations
The service connects to ActiveMQ and other internal components.
-   **Queue Configuration**:
    Create `src/main/resources/registration-processor-abis.json` using `registration-processor-abis-sample.json` as a template. Update the `brokerUrl` and queue names as needed.
-   **Partner Certificate**:
    Place `cbeff.p12` in the `src/main/resources` folder if encryption is enabled.

## üê≥ Local Setup using docker image
To run using an existing Docker image:
1.  Ensure you have `sample-docker-compose.yml` or create a `docker-compose.yml`.
2.  Run the following command:
    ```bash
    docker-compose -f sample-docker-compose.yml up
    ```
    *(Note: Ensure ActiveMQ is running and reachable).*

## üèóÔ∏è Local Setup by building docker image
To build the image locally and run:
1.  **Build the Project**:
    ```bash
    mvn clean install -Dgpg.skip=true
    ```
2.  **Build Docker Image**:
    ```bash
    docker build --file Dockerfile --tag mock-abis .
    ```
3.  **Run Container**:
    Use the `docker-compose.yml` or run manually:
    ```bash
    docker run -p 8081:8081 mock-abis
    ```

## ‚òï Local Setup using JAR
Recommended for active development.
1.  **Setup Queue Config**:
    -   Create `registration-processor-abis.json` in `src/main/resources`.
    -   Update queue details.
2.  **Prepare Libs**:
    -   Download `kernel-auth-adapter-1.3.0-SNAPSHOT.jar` (or relevant version) and place it in a `lib` folder.
3.  **Build**:
    ```bash
    mvn clean install -Dgpg.skip=true
    ```
4.  **Run**:
    ```bash
    java -Dloader.path=lib/kernel-auth-adapter-1.3.0-SNAPSHOT.jar \
    -Dlocal.development=true -Dabis.bio.encryption=true \
    -Dspring.profiles.active=local -Dmosip_host=https://<mosip-server-host> \
    --add-opens java.xml/jdk.xml.internal=ALL-UNNAMED \
    --add-opens java.base/java.lang.reflect=ALL-UNNAMED \
    --add-opens java.base/java.lang.stream=ALL-UNNAMED \
    --add-opens java.base/java.time=ALL-UNNAMED \
    --add-opens java.base/java.time.LocalDate=ALL-UNNAMED \
    --add-opens java.base/java.time.LocalDateTime=ALL-UNNAMED \
    --add-opens java.base/java.io.Reader=ALL-UNNAMED \
    --add-opens java.base/java.util.Optional=ALL-UNNAMED \
    --add-opens java.base/java.time.LocalDateTime.date=ALL-UNNAMED \
    -jar target/mock-abis-1.3.0-SNAPSHOT.jar
    ```

## üöÄ Deployment
For deploying in a Kubernetes environment (like Sandbox), the service is deployed as a Docker container. Refer to the specific MOSIP deployment scripts and Helm charts for environmental configuration.

## ‚¨ÜÔ∏è Upgrade
To upgrade:
1.  Git pull latest changes.
2.  Update dependencies in `pom.xml`.
3.  Rebuild: `mvn clean install`.
4.  Rebuild Docker image.

## üìö Documentation
-   **Expectations Guide**: [Sample Expectations](./docs/sampleExpectations.md)

### API Documentation
API endpoints, base URL (repo name), and mock server details are available via Swagger documentation:
[Swagger UI Local](http://localhost:8081/v1/mock-abis-service/swagger-ui/index.html#/)

### Product Documentation
To know more about Mock ABIS in the perspective of functional and use cases you can refer to our main document:
[MOSIP Documentation](https://docs.mosip.io)

## ü§ù Contribution & Community
We welcome contributions from everyone!

[Check here](https://docs.mosip.io/1.2.0/community/code-contributions) to learn how you can contribute code to this application.

If you have any questions or run into issues while trying out the application, feel free to post them in the [MOSIP Community](https://community.mosip.io/) ‚Äî we‚Äôll be happy to help you out.

[![GitHub Issues](https://img.shields.io/badge/GitHub-Issues-181717?style=flat&logo=github&logoColor=white)](https://github.com/mosip/mosip-mock-services/issues)

## üìù License
![License: MPL 2.0](https://img.shields.io/badge/License-MPL_2.0-brightgreen.svg)

This project is licensed under the terms of [Mozilla Public License 2.0](LICENSE).
See the [LICENSE](LICENSE) file for full license details.